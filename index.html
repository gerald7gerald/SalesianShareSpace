<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
      window.onload = function() {
        const credential = localStorage.getItem('googleCredential');

        console.log("Checking stored credentials...");

        // ðŸš¨ Redirect immediately if no credential is found
        if (!credential) {
          console.warn("No credential found! Redirecting...");
          window.location.href = 'Register.html';
          return;
        }

        try {
          const payload = parseJwt(credential);

          // ðŸš¨ Ensure only Gmail accounts are allowed
          if (!payload.email || !payload.email.endsWith('@gmail.com')) {
            alert('Access Denied: Only Gmail accounts are allowed.');
            localStorage.removeItem('googleCredential'); // Remove invalid credentials
            window.location.href = 'Register.html';
            return;
          }

          console.log("âœ… Valid Gmail User:", payload.email);
          // If already logged in, redirect to the main page
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Invalid token:', error);
          localStorage.removeItem('googleCredential'); // Remove invalid token
          window.location.href = 'Register.html';
        }
      };

      function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch (error) {
          throw new Error('Failed to parse JWT');
        }
      }

      function handleCredentialResponse(response) {
        console.log("Google Sign-In Response:", response);

        if (response.credential) {
          console.log("Google Credential:", response.credential);

          // Store credential in localStorage
          localStorage.setItem('googleCredential', response.credential);
          console.log("Credential stored successfully in localStorage.");

          // Reload to trigger the redirect check
          window.location.reload();
        } else {
          console.error("No credential received from Google.");
        }
      }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesian ShareSpace</title>
    <link rel="stylesheet" href="styles.css">

    <link href="https://fonts.googleapis.com/css2?family=Pochaevsk:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <h1><b>Salesian ShareSpace</b></h1>
    </header>

    <nav>
        <a href="#home">Home</a>
        <div class="menu">
            <div class="menu-button">About Us</div>
            <div class="dropdown">
                <a href="purpose.html">What was the Purpose?</a>
            </div>
        </div>
        <a href="#services">Services</a>
        <div class="menu">
            <div class="menu-button">Grade Levels</div>
            <div class="dropdown">
                <a href="9th.html">Freshmen</a>
                <a href="10th.html">Sophomore</a>
                <a href="11th.html">Junior</a>
                <a href="12th.html">Senior</a>
            </div>
        </div>
    </nav> 

    <!-- Google Sign-In Button -->
    <div id="g_id_onload"
         data-client_id="65426095578-6mpocbjur5tik4avgj274of0ia4hkr1i.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="redirect"
         data-login_uri="https://salesiansharespace.pages.dev/callback.html"
         data-auto_prompt="false"
         data-callback="handleCredentialResponse">
    </div>

    <div class="g_id_signin" 
         data-type="standard" 
         data-size="large" 
         data-theme="outline" 
         data-text="sign_in_with" 
         data-shape="rectangular" 
         data-logo_alignment="left">
    </div>

    <main>
        <section id="front page">
            <div class="creator">
                <h2>Pending:</h2>
                <ul>
                    <li>Create a login portal (IMPORTANT)</li>
                    <li>Make the home page look appealing</li>
                    <li>Input teachers and subjects available for each grade</li>
                    <li>Improve website UI design</li>
                </ul>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Salesian ShareSpace. All rights reserved.</p>
    </footer>

    <div style="position: fixed; bottom: 0; left: 0; z-index: 1;">
        <a href="index.html">
            <img src="https://seeklogo.com/images/S/sun-book-logo-E393C7C6AC-seeklogo.com.png" alt="logo" width="100" height="100">
        </a>
    </div>
</body>

</html>
