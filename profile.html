<!-- [UNCHANGED HEAD SECTION OMITTED FOR BREVITY] -->
<body>
  <div class="profile-container">
    <img src="profile.jpg" alt="Profile Picture" class="profile-img" />
    <h2 id="userName">Loading...</h2>

    <div class="name-edit-container">
      <input type="text" id="nameInput" placeholder="Enter your name" />
      <button id="saveNameBtn">Save</button>
    </div>

    <textarea id="bioInput" placeholder="Write a short bio..." rows="3" style="width: 100%; margin-top: 10px;"></textarea>
    <input type="text" id="schoolInput" placeholder="Enter your school..." />
    <input type="text" id="classesInput" placeholder="Enter classes you teach..." />
    <button id="saveProfileBtn">Save All Info</button>

    <p>Web Developer | Tech Enthusiast</p>
    <input type="file" id="fileInput" />
    <button id="uploadBtn">Upload Document</button>
  </div>

  <div class="uploads-container">
    <h3>My Uploads</h3>
    <ul id="uploadsList"></ul>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabase = createClient("https://qpkiqfxdjijgcirdxdrg.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwa2lxZnhkamlqZ2NpcmR4ZHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMjIzNjksImV4cCI6MjA1NjU5ODM2OX0.zQFjMemO2bAcflnaQLJMRtH77jVlH1w1kRarKXQNYVU");


    const userNameEl = document.getElementById("userName");
    const nameInput = document.getElementById("nameInput");
    const bioInput = document.getElementById("bioInput");
    const schoolInput = document.getElementById("schoolInput");
    const classesInput = document.getElementById("classesInput");

    document.getElementById("saveNameBtn").addEventListener("click", async () => {
      const newName = nameInput.value.trim();
      if (!newName) return alert("Enter a valid name");

      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) return alert("Not logged in");

      const { error: updateError } = await supabase.auth.updateUser({
        data: { full_name: newName }
      });

      if (updateError) {
        alert("Update failed.");
        return;
      }

      userNameEl.textContent = newName;
      alert("Name updated!");
    });

    document.getElementById("saveProfileBtn").addEventListener("click", async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) return alert("Not logged in");

      const updates = {
        full_name: nameInput.value.trim(),
        bio: bioInput.value.trim(),
        school: schoolInput.value.trim(),
        classes: classesInput.value.trim()
      };

      const { error: updateError } = await supabase.auth.updateUser({ data: updates });

      if (updateError) return alert("Profile update failed");

      alert("Profile info saved!");
      userNameEl.textContent = updates.full_name;
    });

    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Select a file");

      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) return alert("Not logged in");

      const filePath = `uploads/${user.email}/${Date.now()}_${file.name}`;
      const { error: uploadError } = await supabase.storage
        .from("Salesian_STR")
        .upload(filePath, file);

      if (uploadError) return alert("Upload failed");

      const { data: urlData } = supabase.storage
        .from("Salesian_STR")
        .getPublicUrl(filePath);

      if (!urlData?.publicUrl) return alert("Could not retrieve file URL");

      await supabase.from("uploads").insert([
        { user_email: user.email, name: file.name, url: urlData.publicUrl }
      ]);

      alert("Upload successful!");
      await loadUploads(user.email);
    });

    async function loadUploads(email) {
      const uploadsList = document.getElementById("uploadsList");
      uploadsList.innerHTML = "";

      const { data, error } = await supabase
        .from("uploads")
        .select("*")
        .eq("user_email", email)
        .order("id", { ascending: false });

      if (error) return;

      data.forEach(file => {
        const li = document.createElement("li");
        if (file.name.endsWith(".pdf")) {
          li.innerHTML = `<strong>${file.name}</strong><br><iframe src="${file.url}" frameborder="0"></iframe>`;
        } else if (/\.(png|jpe?g|gif|webp)$/i.test(file.name)) {
          li.innerHTML = `<strong>${file.name}</strong><br><img src="${file.url}" class="thumb" alt="${file.name}"/>`;
        } else {
          li.innerHTML = `<a href="${file.url}" target="_blank">${file.name}</a>`;
        }
        uploadsList.appendChild(li);
      });
    }

    window.onload = async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        alert("Please log in");
        window.location.href = "login.html";
        return;
      }

      const meta = user.user_metadata || {};
      userNameEl.textContent = meta.full_name || user.email;
      nameInput.value = meta.full_name || "";
      bioInput.value = meta.bio || "";
      schoolInput.value = meta.school || "";
      classesInput.value = meta.classes || "";

      await loadUploads(user.email);
    };
  </script>
</body>
</html>
